
machine:
  pre:
    # Add get_pseudomonas to the machine for two required files
    - hg clone https://bitbucket.org/greenelab/get_pseudomonas
    - ln -s get_pseudomonas/gen_spreadsheets.py
    - ln -s get_pseudomonas/get_pseudo_sdrf.py
  services:
    - docker

dependencies:
  override:
    # Go ahead and install requirements.txt. We're going to run tests here
    # first, so that we can make sure the db connections, etc are working.
    - pip install -r adage/requirements.txt

    # Install node/bower requirements and grunt
    - npm install:
        pwd: interface
    - bower install:
        pwd: interface

    # set region so we can use the aws command-line tool to log into ecr
    #- aws configure set default.region us-west-2
    #- eval $(aws ecr get-login)

    # pull image from ecr to cache docker layers for quicker rebuilds
    - docker pull greenescientist/adageserver:latest

    # build new image
    - bash build.sh
  post:
    - wget https://saucelabs.com/downloads/sc-latest-linux.tar.gz
    - tar -xzf sc-latest-linux.tar.gz

test:
  override:
    # put your test command(s) here
    - python adage/manage.py test adage
    - cd sc-*-linux && ./bin/sc --user=$SAUCE_USERNAME --api-key=$SAUCE_ACCESS_KEY --readyfile=~/sauce_is_ready:
        background: true
    # Wait for tunnel to be ready
    - while [ ! -e ~/sauce_is_ready ]; do sleep 1; done
    - python adage/manage.py migrate
    - python adage/manage.py runserver:
        background: true
    # Wait for app to be ready
    - curl --retry 10 --retry-delay 2 -v http://localhost:8000
    # Run selenium tests
    - grunt:
        pwd: interface
  post:
    - killall --wait sc  # wait for Sauce Connect to close the tunnel

deployment:
  production:
    # only apply this deployment on the master branch
    branch: circle-ci-test

    commands:
      # push image to ecr
      - bash push.sh
